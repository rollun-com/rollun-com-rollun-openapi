# Long task

Long task (лонг таск) - це ресурс, який є реалізацією скінченого автомата, що виконує якусь протяжну у часі дію. 

## Стани лонг таска
Long task має стани, серед яких можна виділити початкові та кінцеві. *Початкові стани* - ті в які лонг таск може
потрапити після свого створення. *Кінцеві стани* - це такі стани, після потрапляння в які, зміна стану лонг таска більше
не можлива.

Кожен стан лонг таску описується набором полей та їх значень. Поле `status` є обов'язковим полем, яке може приймати три
значення:
- `pending` - якщо скінченний автомат НЕ в кінцевому стані
- `fulfilled` - якщо автомат в кінцевому стані і його виконання завершилось успішно
- `rejected` - якщо автомат в кінцевому стані і його виконання завершилось невдало

Поле `stage` є рекомендованим, якщо потрібно більш детально описати поточний етап виконання задачі. 

Поле `problem` у форматі [RFC-7807](https://www.rfc-editor.org/rfc/rfc7807) є обов'язковим при статусі `rejected`

Також можуть бути присутні інші поля, спеціфічні для кожного окремого виду лонг таску, що будуть описувати стан задачі.
На прикладі нижче це поле `orderId`, яке з'являється при `fulfilled` статусі.

Приклад лонг таску по створенню замовлення.

![Order creating stages](img/specification/creating-order-stages.jpg)

## Створення лонг таску

Лонг таск може бути створенний двома способами: напряму або при створенні іншого ресурсу.

Наприклад запит `POST /long-task` створить напряму лонг таск, та поверне його у результаті з 200 OK кодом відповіді.

Другий варіант можливий коли при створенні якогось ресурсу операція пішла асинхроним шляхом. Наприклад ми відправили
запит `POST /resources` та отримали у відповідь код 202 Accepted та ідентифікатор лонг таску. Далі ми можемо
спостерігати за цим лонг таском за окремим шляхом, наприклад `/resources/actions/creation/{task_id}`.

## Ідемпотентність лонг таску

При створенні лонг таску можна передати ключ ідемпотентності. Тоді повторний запит на створення лонг таску з цим самим
ключем вже не створить лонг таск, а або поверне помилку 409 Conflict, або екземпляр, вже створенного минулим запитом,
лонг таску. Це залежить від реалізації сервера.

Тут працює правило один ключ ідемпотнентності - один лонг таск. Тому, якщо наприклад виконання задачі завершилось помилкою,
що призвело до rejected статусу, то цей лонг таск вже не можна ніяк змінити (тому що rejected - кінцевий стан) та,
наприклад, спробувати його перезапустити. Єдиний шлях повторно спробувати виконати дію - це створити новий лонг таск
з новим ключем ідемпотентності.

## Перехід між станами лонг таску

Стани лонг таску можуть змінюватись як сервером, що виконує лонг таск, так і клієнтом, якщо це допустимо.

// TODO: Зміна статусів клієнтом
1. PUT чи POST запит?
2. Сервер разом з лонг таском може надсилати також варіанти переходу до наступного стану (фактично HATEOAS)

## Використання etag

Для запобігання паралельного зміни статусу двома клієнтами, або клієнтом та сервером можна застосовувати Etag заголовок
із специфікації http. Детальніше [тут](https://developer.mozilla.org/ru/docs/Web/HTTP/Headers/ETag)